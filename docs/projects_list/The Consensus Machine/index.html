<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Giuliana Orizzonte and Yuri Westplat">
<meta name="dcterms.date" content="2023-12-12">
<meta name="description" content="Leveraging AI to Reach Consensus">

<title>Giuliana Orizzonte - The Consensus Machine</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Giuliana Orizzonte</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../CV.html" rel="" target="">
 <span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Projects.html" rel="" target="">
 <span class="menu-text">Projects</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <h1 class="title">The Consensus Machine</h1>
                  <div>
        <div class="description">
          Leveraging AI to Reach Consensus
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Work Project</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Giuliana Orizzonte and Yuri Westplat </p>
    </div>
      <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <a href="https://github.com/responsibleIT">
              Responsible IT Amsterdam, Amsterdam University of Applied Sciences
              </a>
            </p>
        </div>
      </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">December 12, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-power-of-consensus" id="toc-the-power-of-consensus" class="nav-link active" data-scroll-target="#the-power-of-consensus">The Power of Consensus </a></li>
  <li><a href="#the-role-of-ai" id="toc-the-role-of-ai" class="nav-link" data-scroll-target="#the-role-of-ai">The Role of AI  </a></li>
  <li><a href="#the-versatility-of-the-consensus-machine" id="toc-the-versatility-of-the-consensus-machine" class="nav-link" data-scroll-target="#the-versatility-of-the-consensus-machine">The Versatility of the Consensus Machine </a></li>
  <li><a href="#the-step-by-step-process" id="toc-the-step-by-step-process" class="nav-link" data-scroll-target="#the-step-by-step-process">The step-by-step process </a></li>
  <li><a href="#final-reflections" id="toc-final-reflections" class="nav-link" data-scroll-target="#final-reflections">Final reflections </a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-left" id="quarto-document-content">




<p><em>N.B.: The Consensus Machine was a group project to which five people contributed their specific skills, from back-end engineering to digital design. The article below, which I authored, is part of the materials that describe the project and is meant to provide its rationale and context. The software of the Consensus Machine is open source and available at https://github.com/responsibleIT/poldermodel.</em></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="consensusmachine.jpg" class="img-fluid figure-img" width="800"></p>
</figure>
</div>
<p>The Consensus Machine is a project commissioned by the Hogeschool van Amsterdam (HvA) and developed by the HvA Werkplaats Responsible IT. The Consensus Machine was initially conceptualized as a Poldermodel. The verb polderen refers to a unique Dutch approach to decision-making and consensus-building. The term originates from the word “polder”, which refers to a piece of low-lying land that has been reclaimed from the sea and protected by dikes. In the context of governance and decision-making, “polderen” reflects the Dutch tradition of reaching consensus through negotiation and compromise among various stakeholders. It emphasizes the importance of inclusive dialogue and collaboration among different parties with diverse interests and viewpoints. In the political and social context, “polderen” has been widely practiced, allowing various interest groups, unions, and governmental bodies to come together and find mutually agreeable solutions to societal challenges. </p>
<p>Our version of a Poldermodel materializes and streamlines this cooperative approach to decision-making. By fostering collaboration between people and artificial intelligence, the project seeks to demonstrate how AI can support people in achieving consensus on complex and controversial issues. This article explores the importance of consensus in society, the opportunities for AI to support people, and the step-by-step process that underpins the functioning of the Poldermodel, aka the Consensus Machine. </p>
<section id="the-power-of-consensus" class="level3">
<h3 class="anchored" data-anchor-id="the-power-of-consensus">The Power of Consensus </h3>
<p>Consensus is a shared agreement among a group of people about what is important, necessary, and acceptable in society. Reaching consensus on a variety of issues is a necessity of living together with others, given that shared norms and values form the basis of functional social organizations and institutions. The fundamental role that consensus plays in society has been discussed at length by sociologists in the field of Consensus Theory (as well as its counterpart, Conflict Theory), although mentions of this topic can already be found in ancient philosophical texts. Consensus is relevant because individuals have different interests and values, and they are affected by issues in different ways. Yet, to function as a whole, groups need to reach agreements on matters that involve all aspects of life beyond the personal. The Consensus Machine is a tool developed to facilitate such an ambitious task because its function is to promote cooperation and mutual understanding among individuals who differ in their histories, values, and expectations. </p>
<p>By facilitating conversations and encouraging dialogue among stakeholders, the project aims to identify a common ground - a solution that may not fully satisfy any single party but is acceptable for all people to implement on a larger scale. In this way, consensus becomes a valuable tool for balancing competing interests and fostering cooperation. </p>
<p>Consensus offers a powerful means of navigating the complexities of our interconnected world. Beyond practical problem-solving, consensus-building fosters a sense of ownership and collective responsibility for decisions. When individuals participate in the decision-making process and feel heard, they are more likely to support and implement the chosen solutions actively.  </p>
</section>
<section id="the-role-of-ai" class="level3">
<h3 class="anchored" data-anchor-id="the-role-of-ai">The Role of AI  </h3>
<p>Behind the curtains of the Consensus Machine lies the advanced AI tool GPT-4, a Large Language Model (LLM) developed by OpenAI. GPT-4 is the engine the powers the much more famous application ChatGPT, which OpenAI describes as a language AI designed to engage in conversations with humans in a seamless and interactive way. In the ChatGPT dialog page users input their questions and ideas, and, in response, GPT-4 processes this information and returns alternative perspectives or potential solutions. </p>
<p>In its intended purpose, the LLM is utilized by a person to arrive at a satisfactory response. We decided to explore its potential beyond the individual human-AI interaction and apply the same LLM to create a tool that serves people as a group. The premise of AI being a tool that supports people may raise some eyebrows. The seemingly inescapable presence of AI in our day-to-day is a new fact of life and it comes with many unknowns about its effects. Many people are critical of its use, and certainly, we must carefully consider and evaluate any harm it may cause. However, AI is a technological tool like many others, and if it may improve or enrich people’s lives, (we believe) we should explore that possibility. This is the raison d’être of the Consensus Machine. In the Consensus Machine, AI acts as a moderating influence to encourage people to find common ground. </p>
<p>We are not suggesting that the LLM used in the Consensus Machine is truly impartial. In fact, we invite each reader to reflect on whether AI can ever be entirely neutral. As a product of human creation and its training data, AI models may inherit the same biases humans carry. That is why the steering wheel of the Consensus Machine is in the hands of people. The role of the AI is to show possible routes, but the choice of where to go remains entirely up to the people using it. In other words, the different interface forces people to interact with AI in a completely new way. Whereas when using an LLM in a “traditional” way the user and the machine exchange the roles of givers and receivers, here people are players in the game of reaching an agreement and the LLM is the referee. The AI offers options, but the experience begins and ends with the people taking part in it. Humans are no longer users of technology but participants in a shared experience and they will always make the final decision.</p>
</section>
<section id="the-versatility-of-the-consensus-machine" class="level3">
<h3 class="anchored" data-anchor-id="the-versatility-of-the-consensus-machine">The Versatility of the Consensus Machine </h3>
<p>One of the Consensus Machine’s defining strengths is its versatility. Its purpose is to help people achieve common ground on a controversial issue, meaning that the project is not confined to specific topics or domains; it can be presented in any public environment and adapted to cover a wide range of complex issues. Whether used in educational institutions, community organizations, or government agencies, the Consensus Machine proves its utility as a platform for constructive dialogue and collective problem-solving. </p>
<p>Public spaces provide an ideal setting for the Consensus Machine’s implementation. They offer opportunities for individuals from diverse backgrounds and walks of life to come together, thus encouraging open communication and exchange of ideas, which contributes to a culture of active listening and respect. </p>
<p>In its first iteration, the Consensus Machine addresses the challenging issue of proctoring software for online examinations. This topic often sparks conflicting, and sometimes irreconcilable, viewpoints among students, educators, and administrators and thus makes it an appropriate topic to investigate with the Consensus Machine. </p>
</section>
<section id="the-step-by-step-process" class="level3">
<h3 class="anchored" data-anchor-id="the-step-by-step-process">The step-by-step process </h3>
<p>The Consensus Machine operates through a systematic and iterative process, which is depicted in the flowchart below. </p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="flowchart.png" class="img-fluid figure-img" width="335"></p>
</figure>
</div>
<ul>
<li><p><strong>Prompt:</strong> The process begins with a vague statement on a controversial issue, which serves as the starting point for the consensus-building exercise.  The goal of this experience is to allow people with differing viewpoints on a certain issue to find common ground. An optimal solution may not exist, so together they can look for the least unsatisfactory option for each individual or, in other words, the most satisfactory solution for the group as a whole. In the first Consensus Machine experiment, we ask students, educators, policymakers, and employees of the HvA to reflect on the use of proctoring software in online examinations. Indeed, there is much to consider on this matter and different values will lead participants to different standpoints. Instead of arguing in favor or against proctoring software, we ask participants to find a solution that is fair and acceptable to most. </p></li>
<li><p><strong>First selection:</strong> Participants are encouraged to identify the part of the statement they are not satisfied with. This step lays the foundation for the subsequent interactions. The ball is in the participants’ court, they have to start the process. Given the statement they are presented with, which part is most important to change? Participants need to select a sentence from the statement to modify according to what they believe is important. A different iteration of The Consensus Machine that we worked on allowed participants to choose individual words as opposed to an entire sentence. However, during development, this change was made to improve the coherence of the whole text. Because we work with an LLM, there is a need to balance output quality, program efficiency, and ease of use. While choosing individual words allows the participants more freedom of choice, it comes at the cost of output quality and efficiency, which we found to be an undesirable trade-off. </p></li>
<li><p><strong>Alternatives:</strong> GPT-4, the AI moderator, generates alternative sentences based on participants’ selections. These alternatives represent different perspectives on the initial statement. At this step, the sentence that participants chose to modify is used as input in a request for GPT-4 to generate alternatives. GPT-4 is not entirely free in producing alternatives, as, behind the scenes, we provided contextual information and some constraints. The context that we asked GPT-4 to use in coming up with alternatives is the framework of values for education developed by SURF and Kennisnet: De WaardenWijzer. Additionally, GPT-4 is instructed to produce six alternatives to the selected sentence whose sentiment range from “completely in favor of proctoring software” to neutral to “completely against proctoring software”. These are the options presented to the participants at the next step. Finally, we instruct GPT-4 to keep the alternative sentences short. </p></li>
<li><p><strong>Second Selection:</strong> Participants are presented with the generated alternative sentences and choose the one that best aligns with their point of view. After the input is provided to GPT-4, it will generate the six alternative sentences. Based on the received outputs, these alternatives are presented to the participants. They now have to decide – which one best represents the viewpoint of the group? At the very least, which one comes the closest? Once the participants are ready, they need to communicate their choice to the machine to continue the process. </p></li>
<li><p><strong>Integrate the new statement:</strong> The chosen alternative is fed back to GPT-4, which is tasked with integrating this new perspective into the overall statement. Now the Consensus Machine needs some time to “think” things through. The chosen sentence will replace the previous one, but that is not a sufficient change all together. We want to keep the entire text coherent, meaning that some changes will need to be made to the rest of the statement to be in line with the perspective of the updated sentence. We instruct GPT-4 to change enough of the remaining text so that it remains overall logical and meaningful, but also as little as possible so that the participants remain in control of the viewpoint that is expressed. The LLM is meant to be an aide while the participants remain the authors of the statement. </p></li>
<li><p><strong>Updated Statement:</strong> The revised statement, incorporating the AI-generated alternative, is presented to the participants. At this stage, participants evaluate their satisfaction with the current state and decide whether additional changes are necessary.  Once the statement has been appropriately updated, it is shown to the participants. At this point, they have to decide whether they have reached a consensus or whether there is more change needed to arrive on the same page. </p></li>
<li><p><strong>Iterate:</strong> If required, participants can repeat the process, making further updates to the statement. This iterative approach ensures a comprehensive exploration of perspectives and fosters a deeper understanding of the issue.  If they decide another update is needed, they can iterate the process. They can select a sentence to work on and repeat the steps to arrive at an updated statement. There is no limit to the number of iterations the participants can go through, the group is in full control of the process. </p></li>
<li><p><strong>Reach consensus:</strong> Once all participants are satisfied with the statement and feel that it adequately represents a shared agreement, they can choose to end the process and declare that consensus has been reached.  When they feel that the current version of the statement is acceptable and no further changes have to be made, they can let the machine know that a satisfactory outcome has been reached. The participants can click on the button and the process ends. The final statement is published online with a record of the process; everything is saved and published online. </p></li>
</ul>
</section>
<section id="final-reflections" class="level3">
<h3 class="anchored" data-anchor-id="final-reflections">Final reflections </h3>
<p>The Consensus Machine is both a technological experiment and an optimistic vision for the future of the exchange between humans and AI machines. By leveraging AI’s generative power and embracing people’s differences, the project displays the potential of collective efforts in addressing complex challenges. The power of consensus lies in its ability to bridge gaps, promote understanding, and foster cooperation among people with diverse viewpoints and priorities. Additionally, the Consensus Machine emphasizes the importance of responsible AI use, placing people at the forefront of the decision-making process. </p>
<p>As we move forward into an increasingly AI-driven world, projects like The Consensus Machine offer a glimpse into a future where technology continues to support human endeavors. By actively engaging with AI, critically evaluating its suggestions, disputing the outcomes of the AI collectively and arriving at shared solutions, we can shape a future where AI serves as a valuable tool for society, augmenting our capabilities for the benefit of all. </p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>